<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FriendApp â€” Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/ui.css">
</head>
<body class="bg">
  <main class="row gap">
    <aside class="card w-80">
      <header class="card-h"><h2>ðŸ‘¤ Me</h2></header>
      <section class="p">
        <img id="me_avatar" class="avatar">
        <div id="me_name" class="mt-2"></div>
        <div id="me_phone" class="muted"></div>
        <div class="mt-4 grid1">
          <a class="btn" href="/setup.html">Edit profile</a>
          <button id="logout" class="btn btn-rose">Logout</button>
        </div>
      </section>
    </aside>

    <section class="card flex-1">
      <header class="card-h"><h1>ðŸ‘‹ FriendApp</h1></header>
      <section class="p">
        <div class="row gap">
          <button id="btn_audio" class="btn btn-blue">ðŸŽ¤ Random Audio</button>
          <button id="btn_video" class="btn btn-green">ðŸ“¹ Random Video</button>
          <button id="btn_cancel" class="btn">Cancel</button>
        </div>
        <div id="status" class="muted mt-2"></div>

        <h3 class="mt-6">ðŸŸ¢ Online users <span class="muted">(tap to call)</span></h3>
        <div id="online" class="grid3 mt-2"></div>
      </section>
    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $=id=>document.getElementById(id);
    const token=localStorage.getItem('fa_token'); if(!token) location.href='/login.html';

    const api=async(p,b)=>{const r=await fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});if(!r.ok)throw new Error((await r.json()).error||'Failed');return r.json();};
    (async()=>{
      const me=await api('/api/me',{token});
      $('me_name').textContent=me.name;
      $('me_phone').textContent=me.phone;
      $('me_avatar').src=me.profile?.avatar||'';
      if(!me.profile?.gender || !me.profile?.language) location.href='/setup.html';
    })().catch(()=>location.href='/login.html');

    const socket = io();
    socket.on('connect', ()=> socket.emit('auth',{token}));
    socket.on('auth_ok', ()=> socket.emit('presence_get'));

    socket.on('presence', (list)=>{
      const box=$('online'); box.innerHTML='';
      list.filter(u=>!!u.free).forEach(u=>{
        const div=document.createElement('button');
        div.className='tile';
        div.innerHTML=`<img src="${u.avatar}" class="avatar-sm"><div class="grow"><div>${u.name}</div><div class="muted">${u.prefs.language} â€¢ ${u.prefs.gender}</div></div><span class="pill">Call</span>`;
        div.onclick=()=> socket.emit('call_user',{targetToken:u.token,mode:'video'});
        box.appendChild(div);
      });
    });

    // call UX (ringing â†’ accepted handled in your existing app.js if you keep it)
    socket.on('outgoing_call', ({mode,to})=>{
      $('status').textContent=`Calling ${to.name} (${mode})â€¦`;
    });
    socket.on('incoming_call', ({mode,from})=>{
      $('status').textContent=`Incoming ${mode} call from ${from.name}â€¦ open your call UI to accept`;
      // Here you would show your call modal and Accept/Decline buttons,
      // then emit 'call_accept' or 'call_decline'
    });
    socket.on('call_timeout', ()=> $('status').textContent='No answer.');
    socket.on('call_missed',  ()=> $('status').textContent='Missed call.');
    socket.on('call_declined',()=> $('status').textContent='Declined.');
    socket.on('call_accepted',()=> $('status').textContent='Call connected!');

    $('btn_audio').onclick=()=>{ $('status').textContent='Searching audio matchâ€¦'; socket.emit('find_match',{mode:'audio'}); };
    $('btn_video').onclick=()=>{ $('status').textContent='Searching video matchâ€¦'; socket.emit('find_match',{mode:'video'}); };
    $('btn_cancel').onclick=()=> socket.emit('cancel_find',{mode:'audio'}) || socket.emit('cancel_find',{mode:'video'});
    $('logout').onclick=()=>{ localStorage.removeItem('fa_token'); location.href='/login.html'; };
  </script>
</body>
</html>
